<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Catalogue AHPV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Librairies nécessaires -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/searchpanes/2.1.0/js/dataTables.searchPanes.min.js"></script>
  <script src="https://cdn.datatables.net/select/1.5.0/js/dataTables.select.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.0/css/searchPanes.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/select/1.5.0/css/select.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 30px;
    }
    h1 {
      text-align: center;
      color: #0a4d78;
      font-size: 1.8em;
    }
    #logo {
      display: block;
      margin: 0 auto 15px;
      max-height: 100px;
    }
    table.dataTable thead th {
      background-color: #e9f1f7;
    }
    .data-source {
      font-size: 0.9em;
      text-align: center;
      margin-top: 1em;
      color: #666;
    }
  </style>
</head>

<body>
  <img id="logo" src="logo_ahpv.png" alt="Logo AHPV" />
  <h1>Catalogue des publications des Amis de l’Histoire du Pays Vizillois</h1>

  <table id="data-table" class="display" style="width: 100%"></table>

  <p class="data-source">
    Source des données : <a href="base_ahpv_enriched_simplified.csv" download>base_ahpv_enriched_simplified.csv</a>
  </p>

  <script>
    fetch("base_ahpv_enriched_simplified.csv")
      .then((response) => response.text())
      .then((csv) => {
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            const data = results.data;
            const table = $("#data-table").DataTable({
              data: data,
              columns: [
                { title: "Numéro", data: "Numero" },
                { title: "Titre", data: "Titre" },
                { title: "Pages", data: "Pages" },
                { title: "Auteurs", data: "Auteurs" },
                {
                  title: '<i class="fa-solid fa-location-dot"></i> Villes',
                  data: "Villes",
                  searchPanes: { show: true }
                },
                {
                  title: '<i class="fa-solid fa-tags"></i> Thèmes',
                  data: "Themes",
                  searchPanes: { show: true }
                },
                {
                  title: '<i class="fa-solid fa-calendar-days"></i> Époque',
                  data: "Epoque",
                  searchPanes: { show: true }
                },
                {
                  title: '<i class="fa-solid fa-clock"></i> Siècle',
                  data: "Siecle",
                  searchPanes: { show: true }
                },
                {
                  title: "Détails",
                  data: null,
                  defaultContent:
                    "<button class='details-btn'>Voir</button>",
                  orderable: false,
                  searchable: false,
                },
              ],
              dom: "Plfrtip",
              searchPanes: {
                cascadePanes: true,
                viewTotal: true,
                initCollapsed: true,
              },
              pageLength: 25,
              lengthMenu: [10, 25, 50, 100],
              language: {
                url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json",
              },
            });

            function formatDetail(rowData) {
              return `
                <div style="padding:10px;">
                  <strong>Titre :</strong> ${rowData["Titre"] || ""}<br>
                  <strong>Pages :</strong> ${rowData["Pages"] || ""}<br>
                  <strong>Auteurs :</strong> ${rowData["Auteurs"] || ""}<br>
                  <strong>Villes :</strong> ${rowData["Villes"] || ""}<br>
                  <strong>Thèmes :</strong> ${rowData["Themes"] || ""}<br>
                  <strong>Époque :</strong> ${rowData["Epoque"] || ""} <br>
                  <strong>Siècle :</strong> ${rowData["Siecle"] || ""}
                </div>`;
            }

            $("#data-table tbody").on("click", "button.details-btn", function () {
              const tr = $(this).closest("tr");
              const row = table.row(tr);
              if (row.child.isShown()) {
                row.child.hide();
                tr.removeClass("shown");
              } else {
                row.child(formatDetail(row.data())).show();
                tr.addClass("shown");
              }
            });
          },
        });
      })
      .catch((error) => {
        document.body.innerHTML +=
          "<p style='color:red;'>Erreur de chargement du fichier CSV.</p>";
        console.error(error);
      });
  </script>
</body>
</html>
